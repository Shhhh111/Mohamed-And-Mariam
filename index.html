<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’• Ù…Ø­Ù…Ø¯ ÙˆÙ…Ø±ÙŠÙ… - Ø´Ø§Øª Ø§Ù„Ø­Ø¨ ğŸ’•</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 50%, #6c5b7b 100%);
        }

        .container {
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-screen {
            padding: 20px;
            text-align: center;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 28px;
            color: #ff6b9d;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .user-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .user-card {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            padding: 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            border: 3px solid transparent;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
        }

        .user-card.selected {
            border-color: #fff;
            transform: scale(1.05);
        }

        .user-card h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-card.mariam {
            background: linear-gradient(135deg, #ffa8c5 0%, #ff6b9d 100%);
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            display: none;
        }

        .password-input.show {
            display: block;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Chat Screen */
        .chat-screen {
            display: none;
            height: 100%;
            width: 100%;
        }

        .chat-screen.active {
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid white;
        }

        .chat-info {
            flex: 1;
        }

        .chat-info h2 {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .chat-info p {
            font-size: 12px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .message-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 5px;
            cursor: pointer;
        }

        .message-file {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .message.received .message-file {
            background: #f0f0f0;
        }

        .delete-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
        }

        .message.received .delete-btn {
            background: #ffebee;
            color: #e53e3e;
        }

        .message.selected .message-bubble {
            border: 3px solid #ff6b9d;
            box-shadow: 0 0 15px rgba(255, 107, 157, 0.5);
        }

        .admin-controls {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 1500;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 350px;
        }

        .admin-controls.show {
            display: flex;
        }

        .admin-control-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .admin-control-btn.delete {
            background: linear-gradient(135deg, #e53e3e 0%, #c62828 100%);
        }

        .admin-control-btn.cancel {
            background: linear-gradient(135deg, #888 0%, #666 100%);
        }

        .selection-mode-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            padding: 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1600;
        }

        .selection-mode-header.show {
            display: flex;
        }

        .selection-mode-header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Input Area */
        .input-area {
            background: white;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .attachment-preview {
            display: none;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .attachment-preview.show {
            display: block;
        }

        .preview-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
        }

        .preview-file {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .attach-btn {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .attach-btn:hover {
            background: #e0e0e0;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .message-input:focus {
            border-color: #ff6b9d;
        }

        .send-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Profile Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ff6b9d;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .profile-edit {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-edit label {
            font-weight: bold;
            color: #333;
        }

        .profile-edit input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .save-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: toastSlide 0.3s ease;
        }

        @keyframes toastSlide {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .toast.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        /* Music Player Sidebar */
        .music-sidebar {
            position: fixed;
            left: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
            z-index: 3000;
            display: flex;
            flex-direction: column;
        }

        .music-sidebar.show {
            left: 0;
        }

        .music-header {
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .music-header h2 {
            font-size: 20px;
        }

        .close-music {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }

        .music-iframe-container {
            flex: 1;
            overflow: hidden;
        }

        .music-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .music-controls {
            background: #f5f5f5;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .now-playing {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .now-playing h3 {
            color: #ff6b9d;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .now-playing p {
            color: #666;
            font-size: 14px;
        }

        .music-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
        }

        .music-overlay.show {
            display: block;
        }

        .music-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            max-width: 300px;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .music-notification.show {
            display: block;
        }

        .music-notification h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .music-notification p {
            font-size: 12px;
            opacity: 0.9;
        }

        .music-sidebar {
            width: 100%;
            left: -100%;
        }

        .music-sidebar.show {
            left: 0;
        }
        img{
            border-radius: 50%;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Login Screen -->
   <div class="login-screen" id="loginScreen">
    <div class="login-header">
     <h1>ğŸ’• Ø´Ø§Øª Ø§Ù„Ø­Ø¨ ğŸ’•</h1>
     <br>
     <img src="logo_mohamed_and_mariam.ico" alt="logo_mohamed_and_mariam" height="150" width="150">
     <br>
     <p>Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
    </div>
    <div class="user-selection">
     <div class="user-card" onclick="selectUser('mohamed')">
      <h2>Ù…Ø­Ù…Ø¯</h2>
      <p>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø³Ø±</p>
     </div>
     <div class="user-card mariam" onclick="selectUser('mariam')">
      <h2>Ù…Ø±ÙŠÙ…</h2>
      <p>Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ø³Ø±</p>
     </div>
    </div><input type="password" id="passwordInput" class="password-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"> <button class="login-btn" id="loginBtn" onclick="login()"> Ø¯Ø®ÙˆÙ„ ğŸ’– </button> <button class="login-btn" onclick="downloadApp()" style="background: linear-gradient(135deg, #6c5b7b 0%, #355c7d 100%); margin-top: 15px;"> ğŸ“± ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø£ÙØ¶Ù„ </button>
    <p class="error-message" id="errorMessage">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</p>
   </div><!-- Chat Screen -->
   <div class="chat-screen" id="chatScreen">
    <div class="chat-header">
     <div class="profile-pic" id="headerProfilePic">
      
     </div>
     <div class="chat-info">
      <h2 id="headerName">Ù…Ø­Ù…Ø¯</h2>
      <p id="headerStatus">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: Ø§Ù„Ø¢Ù†</p>
     </div><button class="logout-btn" id="adminSelectBtn" onclick="toggleAdminSelection()" style="display: none;">âœï¸ ØªØ­Ø¯ÙŠØ¯</button> <button class="logout-btn" onclick="downloadApp()">ğŸ“±</button> <button class="logout-btn" onclick="showProfileModal()">âš™ï¸</button> <button class="logout-btn" onclick="emergencyExit()" style="background: #e53e3e;">ğŸš¨</button> <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="messages-container" id="messagesContainer">
     <div class="empty-state">
      <h3>ğŸ’•</h3>
      <p>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ù…ÙŠÙ„Ø©</p>
     </div>
    </div>
    <div class="input-area">
     <div class="attachment-preview" id="attachmentPreview"><button class="remove-preview" onclick="removeAttachment()">Ã—</button>
      <div id="previewContent"></div>
     </div>
     <div class="input-controls"><button class="attach-btn" onclick="document.getElementById('imageInput').click()"> ğŸ“· </button> <button class="attach-btn" onclick="document.getElementById('cameraInput').click()"> ğŸ“¸ </button> <button class="attach-btn" onclick="document.getElementById('fileInput').click()"> ğŸ“ </button> <button class="attach-btn" onclick="document.getElementById('videoInput').click()"> ğŸ¥ </button>
     </div>
     <form class="message-form" id="messageForm"><textarea class="message-input" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨... (Shift+Enter Ù„Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯)" required rows="1" style="resize: none; overflow-y: auto; max-height: 150px; line-height: 1.5;"></textarea> <button type="submit" class="send-btn" id="sendBtn"> ğŸ’• </button>
     </form><input type="file" id="imageInput" accept="image/*" onchange="handleFileSelect(event, 'image')"> <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'camera')"> <input type="file" id="fileInput" onchange="handleFileSelect(event, 'file')"> <input type="file" id="videoInput" accept="video/*" onchange="handleFileSelect(event, 'video')">
    </div>
   </div>
  </div><!-- Profile Modal -->
  <div class="modal" id="profileModal">
   <div class="modal-content">
    <div class="modal-header">
     <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><button class="close-modal" onclick="closeProfileModal()">Ã—</button>
    </div>
    <div class="profile-edit"><label>Ø§Ù„Ø§Ø³Ù…:</label> <input type="text" id="profileName" placeholder="Ø§Ù„Ø§Ø³Ù…"> <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label> <input type="text" id="profileStatus" placeholder="Ø§Ù„Ø­Ø§Ù„Ø©"> <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠ:</label> <input type="text" id="profileEmoji" placeholder="ğŸ‘¨ Ø£Ùˆ ğŸ‘©" maxlength="2"> <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„:</label>
     <div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="profileImageUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex: 1;"> <button type="button" class="attach-btn" onclick="document.getElementById('profileImageInput').click()" style="padding: 10px 15px;"> ğŸ“· Ø±ÙØ¹ </button>
     </div><input type="file" id="profileImageInput" accept="image/*" onchange="handleProfileImageUpload(event)" style="display: none;">
     <div id="profileImagePreview" style="display: none; margin-top: 10px;"><img id="profileImagePreviewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 3px solid #ff6b9d;">
     </div><button class="save-btn" onclick="saveProfile()"> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ğŸ’¾ </button> <button class="save-btn" id="notificationBtn" onclick="enableNotifications()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); margin-top: 10px;"> ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª </button>
     <div id="adminControls" style="display: none;">
      <hr style="margin: 20px 0;">
      <h3 style="color: #ff6b9d; margin-bottom: 15px;">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3><button class="save-btn" onclick="editMariamProfile()" style="background: linear-gradient(135deg, #ffa8c5 0%, #ff6b9d 100%);"> ğŸ‘© ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±ÙˆÙÙŠÙ„ Ù…Ø±ÙŠÙ… </button> <button class="save-btn" onclick="changeMariamPassword()" style="background: linear-gradient(135deg, #6c5b7b 0%, #355c7d 100%); margin-top: 10px;"> ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø± Ù…Ø±ÙŠÙ… </button> <button class="save-btn" onclick="changeAdminPassword()" style="background: linear-gradient(135deg, #355c7d 0%, #2c3e50 100%); margin-top: 10px;"> ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ </button> <button class="save-btn" onclick="changePlaylistUrl()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); margin-top: 10px;"> ğŸµ ØªØºÙŠÙŠØ± Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ </button> <button class="save-btn" onclick="exportAllData()" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); margin-top: 10px;"> ğŸ’¾ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª </button> <button class="save-btn" onclick="showDeviceInfo()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); margin-top: 10px;"> ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø´Ø¨ÙƒØ© </button> <button class="save-btn" onclick="clearAllMessages()" style="background: #e53e3e; margin-top: 10px;"> ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ </button> <button class="save-btn" onclick="resetAllData()" style="background: #d32f2f; margin-top: 10px;"> âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡ </button>
     </div>
    </div>
   </div>
  </div><!-- Toast Notification -->
  <div class="toast" id="toast"></div><!-- Music Player Sidebar -->
  <div class="music-overlay" id="musicOverlay" onclick="closeMusicPlayer()"></div>
  <div class="music-sidebar" id="musicSidebar">
   <div class="music-header">
    <h2>ğŸµ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ</h2><button class="close-music" onclick="closeMusicPlayer()">Ã—</button>
   </div>
   <div class="music-iframe-container"><iframe id="musicIframe" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen> </iframe>
   </div>
   <div class="music-controls">
    <div class="now-playing" id="nowPlaying" style="display: none;">
     <h3>ğŸµ Ø§Ù„Ø¢Ù† ÙŠØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
     <p id="currentSongTitle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØºÙ†ÙŠØ©</p>
    </div>
   </div>
  </div><!-- Music Notification -->
  <div class="music-notification" id="musicNotification">
   <h4>ğŸµ ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø£ØºÙ†ÙŠØ©</h4>
   <p id="musicNotificationText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div><!-- Selection Mode Header -->
  <div class="selection-mode-header" id="selectionModeHeader">
   <div><span id="selectedCount">0</span> Ù…Ø­Ø¯Ø¯
   </div><button onclick="cancelSelection()">Ø¥Ù„ØºØ§Ø¡</button>
  </div><!-- Admin Controls -->
  <div class="admin-controls" id="adminControls"><button class="admin-control-btn" onclick="editSelectedMessages()"> âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© </button> <button class="admin-control-btn delete" onclick="deleteSelectedMessages()"> ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© </button> <button class="admin-control-btn cancel" onclick="cancelSelection()"> âŒ Ø¥Ù„ØºØ§Ø¡ </button>
  </div>
  <script>
        // JSONBin Configuration
        const JSONBIN_API_KEY = '$2a$10$EVEgnKcuZEoujGa1B3HQmuU7C3Eh6NfJFdYR9IH0r1mQR3UAc2SU2';
        const JSONBIN_BIN_ID = '69127ce1ae596e708f515e36';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

        // Admin Password
        const ADMIN_PASSWORD = 'ipMohamedHany001010';

        // Current User
        let currentUser = null;
        let selectedLoginUser = null;
        let currentAttachment = null;
        let isLoading = false;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let allData = {
                messages: [],
                profiles: {
                    mohamed: {
                        name: 'Ù…Ø­Ù…Ø¯',
                        emoji: '',
                        status: 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†',
                        lastSeen: new Date().toISOString(),
                        imageUrl: 'https://scontent.fcai19-7.fna.fbcdn.net/v/t39.30808-6/515439941_122146277504855091_3972673970746458334_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=FYt_PqoQ_JwQ7kNvwFH7-L5&_nc_oc=AdlMx394HWZkfp0ZYFpCOJQtjnCvp9ts-kPTNV-S27N05efVn2BUX4rQG4P6RSSTvJc&_nc_zt=23&_nc_ht=scontent.fcai19-7.fna&_nc_gid=Qv_ctGwsGRfSMnerWmsHPw&oh=00_AfiIa5Us7tZd0rVeru2Vo_Wa9vuXxzVO1ffr9l5HGi-0bQ&oe=69192945',
                        imageData: ''
                    },
                    mariam: {
                        name: 'Ù…Ø±ÙŠÙ…',
                        emoji: '',
                        status: 'Ù…ØªØµÙ„Ø© Ø§Ù„Ø¢Ù†',
                        lastSeen: new Date().toISOString(),
                        imageUrl: 'https://tse1.mm.bing.net/th/id/OIP.A4Tr3kMRtXm2vd69CD7NAgHaEJ?cb=ucfimg2ucfimg=1&rs=1&pid=ImgDetMain&o=7&rm=3',
                        imageData: ''
                    }
                },
                passwords: {},
                notificationSettings: {},
                deviceInfo: {
                    mainDevice: {
                        ip: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...',
                        mac: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...',
                        timestamp: new Date().toISOString()
                    },
                    networkDevices: []
                }
            };

        // Initialize App
        async function initApp() {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
            
            // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø´Ø¨ÙƒØ©
            await fetchDeviceInfo();
            
            const loaded = await loadData();
            
            if (!loaded) {
                console.log('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
                showToast('ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.');
            }

            const savedUser = localStorage.getItem('lastLoggedInUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData.user === 'mariam') {
                        console.log('âœ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø±ÙŠÙ…');
                        currentUser = 'mariam';
                        showChatScreen();
                    }
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', e);
                }
            }
        }

        // Fetch Device Information
        async function fetchDeviceInfo() {
            try {
                console.log('ğŸ“± Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²...');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const mainIP = ipData.ip;
                
                // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù† IP
                const geoResponse = await fetch(`https://ipapi.co/${mainIP}/json/`);
                const geoData = await geoResponse.json();
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ MAC address (Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§ØµØ©)
                let macAddress = await getMacAddress();
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                allData.deviceInfo.mainDevice = {
                    ip: mainIP,
                    mac: macAddress,
                    hostname: geoData.city || 'Unknown',
                    country: geoData.country_name || 'Unknown',
                    isp: geoData.org || 'Unknown',
                    latitude: geoData.latitude,
                    longitude: geoData.longitude,
                    timestamp: new Date().toISOString()
                };
                
                console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:', allData.deviceInfo.mainDevice);
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©
                await scanNetworkDevices(mainIP);
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await saveData();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
                allData.deviceInfo.mainDevice = {
                    ip: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨',
                    mac: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨',
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Get MAC Address
        async function getMacAddress() {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ MAC Ù…Ù† WebRTC
                const rtcPeerConnection = new (window.RTCPeerConnection || window.webkitRTCPeerConnection)({
                    iceServers: []
                });
                
                let mac = '';
                rtcPeerConnection.createDataChannel('');
                
                rtcPeerConnection.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate) return;
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
                    const ipAddress = ipRegex.exec(ice.candidate.candidate)[1];
                    mac = ipAddress;
                };
                
                rtcPeerConnection.createOffer().then(offer => {
                    return rtcPeerConnection.setLocalDescription(offer);
                }).catch(err => console.error(err));
                
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ MAC
                setTimeout(() => {
                    rtcPeerConnection.close();
                }, 1000);
                
                return mac || 'ØºÙŠØ± Ù…ØªØ§Ø­';
            } catch (error) {
                console.log('MAC Address: ØºÙŠØ± Ù…ØªØ§Ø­ (ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª)', error);
                return 'ØºÙŠØ± Ù…ØªØ§Ø­ (ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª)';
            }
        }

        // Scan Network Devices
        async function scanNetworkDevices(mainIP) {
            try {
                console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©...');
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¬Ù‡Ø§Ø²
                const ipParts = mainIP.split('.');
                const networkPrefix = `${ipParts[0]}.${ipParts[1]}.${ipParts[2]}`;
                
                const devices = [];
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† 50 Ø¬Ù‡Ø§Ø² Ø¹Ù„Ù‰ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø´Ø¨ÙƒØ©
                const pingPromises = [];
                for (let i = 1; i <= 50; i++) {
                    const testIP = `${networkPrefix}.${i}`;
                    pingPromises.push(
                        fetch(`https://ipapi.co/${testIP}/json/`, { signal: AbortSignal.timeout(2000) })
                            .then(res => res.json())
                            .then(data => {
                                if (data && data.ip && data.ip !== mainIP) {
                                    devices.push({
                                        ip: data.ip,
                                        hostname: data.city || `Device-${i}`,
                                        country: data.country_name || 'Unknown',
                                        isp: data.org || 'Unknown',
                                        isMain: false,
                                        timestamp: new Date().toISOString()
                                    });
                                }
                            })
                            .catch(err => console.log(`ØªØ®Ø·ÙŠ ${testIP}`))
                    );
                }
                
                await Promise.allSettled(pingPromises);
                
                allData.deviceInfo.networkDevices = devices;
                console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${devices.length} Ø¬Ù‡Ø§Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©:`, devices);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø´Ø¨ÙƒØ©:', error);
            }
        }

        // Load Data from JSONBin
        async function loadData() {
            if (isLoading) return false;
            isLoading = true;

            try {
                console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSONBin...');
                
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY,
                        'X-Bin-Meta': 'false'
                    }
                });

                console.log('ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', data);
                    
                    if (data.record) {
                        allData = data.record;
                    } else if (data.messages !== undefined) {
                        allData = data;
                    }

                    // Ensure musicPlayer exists
                    if (!allData.musicPlayer) {
                        allData.musicPlayer = {
                            playlistUrl: 'https://www.youtube.com/watch?v=O9-9P-Xa2iA&list=RDO9-9P-Xa2iA&start_radio=1',
                            currentSong: null,
                            isPlaying: false
                        };
                    }
                    
                    if (currentUser) {
                        renderMessages();
                        updateHeader();
                    }
                    
                    isLoading = false;
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', response.status, errorText);
                    isLoading = false;
                    return false;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                isLoading = false;
                return false;
            }
        }

        // Save Data to JSONBin
        async function saveData() {
            try {
                console.log('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(allData)
                });

                console.log('ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸:', response.status);

                if (response.ok) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', response.status, errorText);
                    throw new Error('Failed to save data');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âŒ');
                return false;
            }
        }

        // User Selection
        function selectUser(user) {
            selectedLoginUser = user;
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.user-card').classList.add('selected');

            const passwordInput = document.getElementById('passwordInput');
            const errorMessage = document.getElementById('errorMessage');

            const storedPassword = allData.passwords?.[user];
            const defaultPassword = user === 'mohamed' ? ADMIN_PASSWORD : null;
            const requiresPassword = storedPassword || defaultPassword;

            if (requiresPassword) {
                passwordInput.classList.add('show');
                passwordInput.focus();
            } else {
                passwordInput.classList.remove('show');
            }

            errorMessage.classList.remove('show');
        }

        // Login
        function login() {
            if (!selectedLoginUser) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const errorMessage = document.getElementById('errorMessage');
            const passwordInput = document.getElementById('passwordInput');

            const storedPassword = allData.passwords?.[selectedLoginUser];
            const defaultPassword = selectedLoginUser === 'mohamed' ? ADMIN_PASSWORD : null;
            const requiredPassword = storedPassword || defaultPassword;

            if (requiredPassword) {
                const enteredPassword = passwordInput.value;
                if (enteredPassword !== requiredPassword) {
                    errorMessage.classList.add('show');
                    return;
                }
            }

            currentUser = selectedLoginUser;

            localStorage.setItem('lastLoggedInUser', JSON.stringify({
                user: currentUser,
                timestamp: new Date().toISOString()
            }));

            allData.profiles[currentUser].lastSeen = new Date().toISOString();
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            recordUserConnection(currentUser);
            
            saveData();

            showChatScreen();
        }

        // Logout
        function logout() {
            if (currentUser) {
                allData.profiles[currentUser].lastSeen = new Date().toISOString();
                saveData();
            }

            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').classList.remove('show');
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Show Chat Screen
        function showChatScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('chatScreen').classList.add('active');
            updateHeader();
            renderMessages();
            
            // Show admin select button for Mohamed
            if (currentUser === 'mohamed') {
                document.getElementById('adminSelectBtn').style.display = 'block';
            }
            
            setInterval(loadData, 3000);
            
            // ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
            setInterval(updateUserActivity, 10000);
        }

        // Update Header
        function updateHeader() {
            const otherUser = currentUser === 'mohamed' ? 'mariam' : 'mohamed';
            const profile = allData.profiles[otherUser];

            const headerPic = document.getElementById('headerProfilePic');
            
            const imageSource = profile.imageData || profile.imageUrl;
            if (imageSource) {
                headerPic.innerHTML = `<img src="${imageSource}" alt="${profile.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${profile.emoji}';">`;
            } else {
                headerPic.textContent = profile.emoji;
            }
            
            document.getElementById('headerName').textContent = profile.name;

            const lastSeen = new Date(profile.lastSeen);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastSeen) / 60000);

            let statusText = '';
            if (diffMinutes < 1) {
                statusText = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ğŸ’š';
            } else if (diffMinutes < 60) {
                statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: Ù…Ù†Ø° ${diffMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else {
                statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${lastSeen.toLocaleString('ar-EG')}`;
            }

            document.getElementById('headerStatus').textContent = statusText;
        }

        // Handle File Selection
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                currentAttachment = {
                    type: type,
                    data: e.target.result,
                    name: file.name,
                    size: file.size,
                    mimeType: file.type
                };

                showAttachmentPreview();
            };

            reader.onerror = function() {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù âŒ');
                event.target.value = '';
            };

            reader.readAsDataURL(file);
        }

        // Show Attachment Preview
        function showAttachmentPreview() {
            const preview = document.getElementById('attachmentPreview');
            const content = document.getElementById('previewContent');

            if (currentAttachment.type === 'image' || currentAttachment.type === 'camera') {
                content.innerHTML = `<img src="${currentAttachment.data}" class="preview-image" alt="Preview">`;
            } else if (currentAttachment.type === 'video') {
                content.innerHTML = `<div class="preview-file">ğŸ¥ ${currentAttachment.name}</div>`;
            } else {
                content.innerHTML = `<div class="preview-file">ğŸ“ ${currentAttachment.name}</div>`;
            }

            preview.classList.add('show');
        }

        // Remove Attachment
        function removeAttachment() {
            currentAttachment = null;
            document.getElementById('attachmentPreview').classList.remove('show');
            document.getElementById('imageInput').value = '';
            document.getElementById('cameraInput').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('videoInput').value = '';
        }

        // Send Message
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();

            if (!text && !currentAttachment) return;

            // Check for /listplay command (Mohamed only)
            if (text === '/listplay' && currentUser === 'mohamed') {
                openMusicPlayer();
                messageInput.value = '';
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            const newMessage = {
                id: Date.now().toString(),
                sender: currentUser,
                text: text,
                timestamp: new Date().toISOString(),
                attachment: currentAttachment
            };

            allData.messages.push(newMessage);

            await saveData();
            
            // ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            await updateUserActivity();

            messageInput.value = '';
            removeAttachment();
            renderMessages();

            sendBtn.disabled = false;

            showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ğŸ’•');
        });

        // Toggle Admin Selection Mode
        function toggleAdminSelection() {
            if (currentUser !== 'mohamed') return;
            
            isSelectionMode = !isSelectionMode;
            selectedMessages.clear();
            
            if (isSelectionMode) {
                document.getElementById('selectionModeHeader').classList.add('show');
                document.getElementById('adminControls').classList.add('show');
                document.getElementById('adminSelectBtn').textContent = 'âŒ Ø¥Ù„ØºØ§Ø¡';
                showToast('Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§');
            } else {
                document.getElementById('selectionModeHeader').classList.remove('show');
                document.getElementById('adminControls').classList.remove('show');
                document.getElementById('adminSelectBtn').textContent = 'âœï¸ ØªØ­Ø¯ÙŠØ¯';
            }
            
            renderMessages();
            updateSelectedCount();
        }

        // Cancel Selection
        function cancelSelection() {
            isSelectionMode = false;
            selectedMessages.clear();
            document.getElementById('selectionModeHeader').classList.remove('show');
            document.getElementById('adminControls').classList.remove('show');
            document.getElementById('adminSelectBtn').textContent = 'âœï¸ ØªØ­Ø¯ÙŠØ¯';
            renderMessages();
        }

        // Toggle Message Selection
        function toggleMessageSelection(messageId) {
            if (!isSelectionMode || currentUser !== 'mohamed') return;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                if (selectedMessages.has(messageId)) {
                    messageDiv.classList.add('selected');
                } else {
                    messageDiv.classList.remove('selected');
                }
            }
            
            updateSelectedCount();
        }

        // Update Selected Count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedMessages.size;
        }

        // Edit Selected Messages
        async function editSelectedMessages() {
            if (currentUser !== 'mohamed' || selectedMessages.size === 0) return;
            
            const newText = prompt(`ØªØ¹Ø¯ÙŠÙ„ ${selectedMessages.size} Ø±Ø³Ø§Ù„Ø©:\n(Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)`);
            if (newText === null || newText.trim() === '') return;
            
            selectedMessages.forEach(messageId => {
                const message = allData.messages.find(msg => msg.id === messageId);
                if (message) {
                    message.text = newText.trim();
                }
            });
            
            const saved = await saveData();
            if (saved) {
                showToast(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ${selectedMessages.size} Ø±Ø³Ø§Ù„Ø© âœ…`);
                cancelSelection();
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âŒ');
            }
        }

        // Delete Selected Messages
        async function deleteSelectedMessages() {
            if (currentUser !== 'mohamed' || selectedMessages.size === 0) return;
            
            const confirmDelete = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${selectedMessages.size} Ø±Ø³Ø§Ù„Ø©ØŸ`);
            if (!confirmDelete) return;
            
            allData.messages = allData.messages.filter(msg => !selectedMessages.has(msg.id));
            
            const saved = await saveData();
            if (saved) {
                showToast(`ØªÙ… Ø­Ø°Ù ${selectedMessages.size} Ø±Ø³Ø§Ù„Ø© âœ…`);
                cancelSelection();
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù âŒ');
            }
        }

        // Render Messages
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (allData.messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ’•</h3>
                        <p>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ù…ÙŠÙ„Ø©</p>
                    </div>
                `;
                return;
            }

            allData.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
                messageDiv.setAttribute('data-message-id', msg.id);
                
                if (selectedMessages.has(msg.id)) {
                    messageDiv.classList.add('selected');
                }

                // Add click handler for selection mode
                if (isSelectionMode && currentUser === 'mohamed') {
                    messageDiv.style.cursor = 'pointer';
                    messageDiv.onclick = () => toggleMessageSelection(msg.id);
                }

                const time = new Date(msg.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let attachmentHTML = '';
                if (msg.attachment) {
                    if (msg.attachment.type === 'image' || msg.attachment.type === 'camera') {
                        attachmentHTML = `<img src="${msg.attachment.data}" class="message-image" onclick="event.stopPropagation(); downloadAttachment('${msg.attachment.data}', '${msg.attachment.name}')" alt="ØµÙˆØ±Ø©">`;
                    } else if (msg.attachment.type === 'video') {
                        attachmentHTML = `
                            <div class="message-file" onclick="event.stopPropagation(); downloadAttachment('${msg.attachment.data}', '${msg.attachment.name}')">
                                ğŸ¥ ${msg.attachment.name}
                            </div>
                        `;
                    } else {
                        attachmentHTML = `
                            <div class="message-file" onclick="event.stopPropagation(); downloadAttachment('${msg.attachment.data}', '${msg.attachment.name}')">
                                ğŸ“ ${msg.attachment.name}
                            </div>
                        `;
                    }
                }

                // Show edit/delete buttons only when NOT in selection mode
                let controlButtons = '';
                if (!isSelectionMode) {
                    const canEdit = (currentUser === 'mohamed') || (currentUser === msg.sender);
                    const canDelete = (currentUser === 'mohamed') || (currentUser === msg.sender);
                    
                    const deleteBtn = canDelete 
                        ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteMessage('${msg.id}')">Ø­Ø°Ù</button>` 
                        : '';

                    const editBtn = canEdit 
                        ? `<button class="delete-btn" onclick="event.stopPropagation(); editMessage('${msg.id}')">ØªØ¹Ø¯ÙŠÙ„</button>` 
                        : '';

                    if (editBtn || deleteBtn) {
                        controlButtons = `
                            <div style="display: flex; gap: 5px;">
                                ${editBtn}
                                ${deleteBtn}
                            </div>
                        `;
                    }
                }

                messageDiv.innerHTML = `
                    <div class="message-bubble" id="msg-${msg.id}">
                        ${msg.text ? `<div class="message-text">${msg.text}</div>` : ''}
                        ${attachmentHTML}
                    </div>
                    <div class="message-time">${time}</div>
                    ${controlButtons}
                `;

                container.appendChild(messageDiv);
            });

            container.scrollTop = container.scrollHeight;
        }

        // Edit Message
        async function editMessage(messageId) {
            const message = allData.messages.find(msg => msg.id === messageId);
            if (!message) return;

            if (currentUser !== 'mohamed' && currentUser !== message.sender) {
                showToast('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„Ùƒ ÙÙ‚Ø· âŒ');
                return;
            }

            const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', message.text);
            if (newText === null) return;
            
            if (newText.trim() === '') {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©');
                return;
            }

            message.text = newText.trim();
            
            const saved = await saveData();
            if (saved) {
                renderMessages();
                showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…');
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âŒ');
            }
        }

        // Delete Message
        async function deleteMessage(messageId) {
            const message = allData.messages.find(msg => msg.id === messageId);
            if (!message) return;

            if (currentUser !== 'mohamed' && currentUser !== message.sender) {
                showToast('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„Ùƒ ÙÙ‚Ø· âŒ');
                return;
            }

            allData.messages = allData.messages.filter(msg => msg.id !== messageId);
            
            const saved = await saveData();
            if (saved) {
                renderMessages();
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù âŒ');
            }
        }

        // Download Attachment
        function downloadAttachment(data, name) {
            const link = document.createElement('a');
            link.href = data;
            link.download = name || 'file';
            link.click();
            showToast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ğŸ“¥');
        }

        // Handle Profile Image Upload
        function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                document.getElementById('profileImagePreviewImg').src = imageData;
                document.getElementById('profileImagePreview').style.display = 'block';
                
                document.getElementById('profileImageUrl').value = '';
                document.getElementById('profileImageUrl').dataset.uploadedImage = imageData;
                
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© âœ… Ø§Ø¶ØºØ· Ø­ÙØ¸ Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§');
            };
            reader.readAsDataURL(file);
        }

        // Show Profile Modal
        function showProfileModal() {
            const profile = allData.profiles[currentUser];
            document.getElementById('profileName').value = profile.name;
            document.getElementById('profileStatus').value = profile.status;
            document.getElementById('profileEmoji').value = profile.emoji;
            document.getElementById('profileImageUrl').value = profile.imageUrl || '';
            
            const imageSource = profile.imageData || profile.imageUrl;
            if (imageSource) {
                document.getElementById('profileImagePreviewImg').src = imageSource;
                document.getElementById('profileImagePreview').style.display = 'block';
            } else {
                document.getElementById('profileImagePreview').style.display = 'none';
            }

            if (currentUser === 'mohamed') {
                document.getElementById('adminControls').style.display = 'block';
            } else {
                document.getElementById('adminControls').style.display = 'none';
            }

            updateNotificationButton();

            document.getElementById('profileModal').classList.add('show');
        }

        // Close Profile Modal
        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // Save Profile
        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const status = document.getElementById('profileStatus').value.trim();
            const emoji = document.getElementById('profileEmoji').value.trim();
            const imageUrlInput = document.getElementById('profileImageUrl');
            const imageUrl = imageUrlInput.value.trim();
            const uploadedImage = imageUrlInput.dataset.uploadedImage;

            if (!name || !emoji) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }

            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                allData.profiles[currentUser].name = name;
                allData.profiles[currentUser].status = status;
                allData.profiles[currentUser].emoji = emoji;
                
                if (uploadedImage) {
                    allData.profiles[currentUser].imageData = uploadedImage;
                    allData.profiles[currentUser].imageUrl = '';
                } else if (imageUrl) {
                    allData.profiles[currentUser].imageUrl = imageUrl;
                    allData.profiles[currentUser].imageData = '';
                }

                const saved = await saveData();
                
                if (saved) {
                    updateHeader();
                    closeProfileModal();
                    
                    delete imageUrlInput.dataset.uploadedImage;
                    
                    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…');
                } else {
                    showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ âŒ');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ âŒ');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Edit Mariam Profile (Admin Only)
        async function editMariamProfile() {
            if (currentUser !== 'mohamed') return;

            const profile = allData.profiles.mariam;
            const name = prompt('Ø§Ø³Ù… Ù…Ø±ÙŠÙ…:', profile.name);
            const emoji = prompt('Ø±Ù…Ø² Ù…Ø±ÙŠÙ…:', profile.emoji);
            const status = prompt('Ø­Ø§Ù„Ø© Ù…Ø±ÙŠÙ…:', profile.status);
            const imageUrl = prompt('Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…Ø±ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', profile.imageUrl || '');

            if (name) allData.profiles.mariam.name = name;
            if (emoji) allData.profiles.mariam.emoji = emoji;
            if (status) allData.profiles.mariam.status = status;
            if (imageUrl !== null) allData.profiles.mariam.imageUrl = imageUrl;

            await saveData();
            updateHeader();
            showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±ÙˆÙÙŠÙ„ Ù…Ø±ÙŠÙ… âœ…');
        }

        // Change Mariam Password (Admin Only)
        async function changeMariamPassword() {
            if (currentUser !== 'mohamed') return;

            const newPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø±ÙŠÙ…:\n(Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)');
            if (newPassword === null) return;

            if (!allData.passwords) {
                allData.passwords = {};
            }

            if (newPassword.trim() === '') {
                delete allData.passwords.mariam;
                showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø© Ø³Ø± Ù…Ø±ÙŠÙ… âœ…');
            } else {
                allData.passwords.mariam = newPassword.trim();
                showToast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø± Ù…Ø±ÙŠÙ… âœ…');
            }

            await saveData();
        }

        // Change Admin Password (Admin Only)
        async function changeAdminPassword() {
            if (currentUser !== 'mohamed') return;

            const currentPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:');
            if (currentPassword !== ADMIN_PASSWORD && currentPassword !== (allData.passwords?.mohamed || ADMIN_PASSWORD)) {
                showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ');
                return;
            }

            const newPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
            if (!newPassword || newPassword.trim() === '') {
                showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ© âŒ');
                return;
            }

            const confirmPassword = prompt('Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
            if (newPassword !== confirmPassword) {
                showToast('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø© âŒ');
                return;
            }

            if (!allData.passwords) {
                allData.passwords = {};
            }

            allData.passwords.mohamed = newPassword.trim();
            await saveData();
            showToast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ âœ…\nØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©');
        }

        // Change Playlist URL (Admin Only)
        async function changePlaylistUrl() {
            if (currentUser !== 'mohamed') return;

            const currentUrl = allData.musicPlayer?.playlistUrl || '';
            const newUrl = prompt('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† YouTube:', currentUrl);
            
            if (newUrl === null) return;
            
            if (newUrl.trim() === '') {
                showToast('Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹ âŒ');
                return;
            }

            if (!allData.musicPlayer) {
                allData.musicPlayer = {};
            }

            allData.musicPlayer.playlistUrl = newUrl.trim();
            await saveData();
            showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ âœ…');
        }

        // Export All Data (Admin Only)
        function exportAllData() {
            if (currentUser !== 'mohamed') return;

            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…');
        }

        // Clear All Messages (Admin Only)
        async function clearAllMessages() {
            if (currentUser !== 'mohamed') return;

            const confirmDelete = prompt('Ø§ÙƒØªØ¨ "Ø­Ø°Ù" Ù„Ù„ØªØ£ÙƒÙŠØ¯:');
            if (confirmDelete !== 'Ø­Ø°Ù') {
                showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
                return;
            }

            allData.messages = [];
            await saveData();
            renderMessages();
            showToast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ âœ…');
        }

        // Reset All Data (Admin Only)
        async function resetAllData() {
            if (currentUser !== 'mohamed') return;

            const confirmReset = prompt('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡!\nØ§ÙƒØªØ¨ "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†" Ù„Ù„ØªØ£ÙƒÙŠØ¯:');
            if (confirmReset !== 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†') {
                showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
                return;
            }

            allData = {
                messages: [],
                profiles: {
                    mohamed: {
                        name: 'Ù…Ø­Ù…Ø¯',
                        emoji: 'ğŸ‘¨',
                        status: 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†',
                        lastSeen: new Date().toISOString(),
                        imageUrl: '',
                        imageData: ''
                    },
                    mariam: {
                        name: 'Ù…Ø±ÙŠÙ…',
                        emoji: 'ğŸ‘©',
                        status: 'Ù…ØªØµÙ„Ø© Ø§Ù„Ø¢Ù†',
                        lastSeen: new Date().toISOString(),
                        imageUrl: '',
                        imageData: ''
                    }
                },
                passwords: {},
                notificationSettings: {},
                musicPlayer: {
                    playlistUrl: 'https://www.youtube.com/watch?v=YQ7SxFTZJW4&list=RDMMYQ7SxFTZJW4&index=1',
                    currentSong: null,
                    isPlaying: false
                }
            };

            await saveData();
            renderMessages();
            updateHeader();
            showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡ âœ…');
        }

        // Show Device Information (Admin Only)
        function showDeviceInfo() {
            if (currentUser !== 'mohamed') {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª âŒ');
                return;
            }

            const mainDevice = allData.deviceInfo?.mainDevice || {};
            const networkDevices = allData.deviceInfo?.networkDevices || [];
            const allUsers = allData.connectedUsers || [];

            let deviceInfo = 'ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:\n\n';
            deviceInfo += `ğŸŒ Ø¹Ù†ÙˆØ§Ù† IP: ${mainDevice.ip || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
            deviceInfo += `ğŸ”— Ø¹Ù†ÙˆØ§Ù† MAC: ${mainDevice.mac || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
            deviceInfo += `ğŸ™ï¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${mainDevice.hostname || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
            deviceInfo += `ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©: ${mainDevice.country || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
            deviceInfo += `ğŸ“¡ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª: ${mainDevice.isp || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
            deviceInfo += `ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${mainDevice.latitude || '?'}, ${mainDevice.longitude || '?'}\n`;
            deviceInfo += `â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${mainDevice.timestamp ? new Date(mainDevice.timestamp).toLocaleString('ar-EG') : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;

            if (networkDevices.length > 0) {
                deviceInfo += `\n\nğŸ–¥ï¸ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ© (${networkDevices.length}):\n`;
                deviceInfo += 'â”€'.repeat(40) + '\n';
                networkDevices.forEach((device, index) => {
                    deviceInfo += `\n${index + 1}. ${device.hostname}\n`;
                    deviceInfo += `   IP: ${device.ip}\n`;
                    deviceInfo += `   Ø§Ù„Ø¯ÙˆÙ„Ø©: ${device.country}\n`;
                });
            } else {
                deviceInfo += `\n\nğŸ–¥ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©`;
            }

            if (allUsers.length > 0) {
                deviceInfo += `\n\n\nğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (${allUsers.length}):\n`;
                deviceInfo += 'â•'.repeat(50) + '\n';
                allUsers.forEach((user, index) => {
                    deviceInfo += `\nğŸ‘¤ ${index + 1}. ${user.userName || 'Ù…Ø³ØªØ®Ø¯Ù…'}\n`;
                    deviceInfo += `   ğŸŒ IP: ${user.ip || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    deviceInfo += `   ğŸ”— MAC: ${user.mac || 'ØºÙŠØ± Ù…ØªØ§Ø­'}\n`;
                    deviceInfo += `   ğŸ™ï¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${user.city || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'}\n`;
                    deviceInfo += `   ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©: ${user.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'}\n`;
                    deviceInfo += `   ğŸ“¡ ISP: ${user.isp || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n`;
                    deviceInfo += `   ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${user.latitude || '?'}, ${user.longitude || '?'}\n`;
                    deviceInfo += `   â° Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${user.lastActivity ? new Date(user.lastActivity).toLocaleString('ar-EG') : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
                    deviceInfo += `   â³ ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„: ${user.connectedAt ? new Date(user.connectedAt).toLocaleString('ar-EG') : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'}\n`;
                });
            } else {
                deviceInfo += `\n\n\nğŸ‘¥ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†`;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '2000';
            modal.onclick = () => modal.remove();

            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '600px';
            content.style.maxHeight = '90vh';
            content.onclick = (e) => e.stopPropagation();

            content.innerHTML = `
                <div class="modal-header">
                    <h2>ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø´Ø¨ÙƒØ©</h2>
                    <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                </div>
                <div style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.5; color: #333; background: #f5f5f5; padding: 15px; border-radius: 10px; overflow-y: auto; max-height: 70vh;">
                    ${deviceInfo}
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="save-btn" onclick="downloadAllDeviceInfo()" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);"> ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª </button>
                    <button class="save-btn" onclick="refreshDeviceInfoData()" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);"> ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª </button>
                    <button class="save-btn" onclick="this.closest('.modal').remove()" style="flex: 1; background: #999;"> Ø¥ØºÙ„Ø§Ù‚ </button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', allData);
        }

        // Download Device Information
        function downloadDeviceInfo() {
            const dataStr = JSON.stringify(allData.deviceInfo, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `devices-info-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© âœ…');
        }

        // Download All Device Information
        function downloadAllDeviceInfo() {
            const dataStr = JSON.stringify({
                deviceInfo: allData.deviceInfo,
                connectedUsers: allData.connectedUsers || [],
                timestamp: new Date().toISOString()
            }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `all-devices-and-users-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…');
        }

        // Refresh Device Information
        async function refreshDeviceInfoData() {
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            await fetchDeviceInfo();
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
            setTimeout(() => showDeviceInfo(), 500);
        }

        // Record User Connection
        async function recordUserConnection(userName) {
            try {
                if (!allData.connectedUsers) {
                    allData.connectedUsers = [];
                }

                const mainDevice = allData.deviceInfo?.mainDevice || {};
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                const existingUserIndex = allData.connectedUsers.findIndex(u => u.userName === userName);
                
                const userData = {
                    userName: userName,
                    ip: mainDevice.ip || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    mac: mainDevice.mac || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                    city: mainDevice.hostname || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©',
                    country: mainDevice.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©',
                    isp: mainDevice.isp || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    latitude: mainDevice.latitude || null,
                    longitude: mainDevice.longitude || null,
                    lastActivity: new Date().toISOString(),
                    connectedAt: existingUserIndex !== -1 ? allData.connectedUsers[existingUserIndex].connectedAt : new Date().toISOString(),
                    sessionCount: existingUserIndex !== -1 ? (allData.connectedUsers[existingUserIndex].sessionCount || 1) + 1 : 1
                };

                if (existingUserIndex !== -1) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    allData.connectedUsers[existingUserIndex] = userData;
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    allData.connectedUsers.push(userData);
                }

                await saveData();
                console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userData);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }

        // Update User Last Activity
        async function updateUserActivity() {
            if (!currentUser || !allData.connectedUsers) return;
            
            const userIndex = allData.connectedUsers.findIndex(u => u.userName === currentUser);
            if (userIndex !== -1) {
                allData.connectedUsers[userIndex].lastActivity = new Date().toISOString();
                await saveData();
            }
        }

        // Open Music Player (Mohamed Only)
        function openMusicPlayer() {
            if (currentUser !== 'mohamed') {
                showToast('Ù…ØªØ­ÙˆÙ„ÙŠØ´ Ø«Ø§Ù†ÙŠ ÙŠØ§ Ù…Ø±Ù…Ø± ğŸ˜‚ğŸ’\nÙ‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù…Ø­Ù…Ø¯ ÙÙ‚Ø· ğŸµ');
                return;
            }

            const playlistUrl = allData.musicPlayer?.playlistUrl || 'https://www.youtube.com/watch?v=YQ7SxFTZJW4&list=RDMMYQ7SxFTZJW4&index=1';
            
            // Convert YouTube URL to embed format
            let embedUrl = playlistUrl;
            if (playlistUrl.includes('youtube.com/watch')) {
                embedUrl = playlistUrl.replace('watch?v=', 'embed/');
                embedUrl = embedUrl.replace('&list=', '?list=');
            }

            document.getElementById('musicIframe').src = embedUrl;
            document.getElementById('musicSidebar').classList.add('show');
            document.getElementById('musicOverlay').classList.add('show');

            showToast('ğŸµ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØºØ§Ù†ÙŠ Ù…ÙØªÙˆØ­Ø©!');
        }

        // Close Music Player
        function closeMusicPlayer() {
            document.getElementById('musicSidebar').classList.remove('show');
            document.getElementById('musicOverlay').classList.remove('show');
        }

        // Show Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Download App
        async function downloadApp() {
            try {
                showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚... ğŸ“±');
                window.open("https://drive.google.com/file/d/144QjVs3ESxcC884nbzbb_MOSf5f_5Ba9/view?usp=sharing", "blank")
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âŒ');
            }
        }

        // Enable Notifications
        async function enableNotifications() {
            const notificationBtn = document.getElementById('notificationBtn');
            
            if (!('Notification' in window)) {
                showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª âŒ');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    if (!allData.notificationSettings) {
                        allData.notificationSettings = {};
                    }
                    
                    allData.notificationSettings[currentUser] = {
                        enabled: true,
                        timestamp: new Date().toISOString()
                    };
                    
                    await saveData();
                    
                    notificationBtn.textContent = 'âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©';
                    notificationBtn.style.background = 'linear-gradient(135deg, #888 0%, #666 100%)';
                    notificationBtn.disabled = true;
                    
                    new Notification('ğŸ’• Ø´Ø§Øª Ø§Ù„Ø­Ø¨', {
                        body: 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!',
                        icon: 'ğŸ’•',
                        badge: 'ğŸ’•'
                    });
                    
                    showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª âœ…');
                    
                    startNotificationMonitoring();
                } else if (permission === 'denied') {
                    showToast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ âš ï¸');
                } else {
                    showToast('Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª âŒ');
            }
        }

        // Start Notification Monitoring
        let lastMessageCount = 0;
        let notificationInterval = null;

        function startNotificationMonitoring() {
            if (notificationInterval) return;
            
            lastMessageCount = allData.messages.length;
            
            notificationInterval = setInterval(async () => {
                if (!allData.notificationSettings || !allData.notificationSettings[currentUser]?.enabled) {
                    return;
                }
                
                await loadData();
                
                if (allData.messages.length > lastMessageCount) {
                    const newMessages = allData.messages.slice(lastMessageCount);
                    
                    newMessages.forEach(msg => {
                        if (msg.sender !== currentUser) {
                            const senderProfile = allData.profiles[msg.sender];
                            
                            new Notification(`ğŸ’• Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${senderProfile.name}`, {
                                body: msg.text || 'ğŸ“ Ù…Ø±ÙÙ‚',
                                icon: 'ğŸ’•',
                                badge: 'ğŸ’•',
                                tag: msg.id,
                                requireInteraction: false
                            });
                        }
                    });
                    
                    lastMessageCount = allData.messages.length;
                }
            }, 5000);
        }

        // Check notification status on modal open
        function updateNotificationButton() {
            const notificationBtn = document.getElementById('notificationBtn');
            
            if (Notification.permission === 'granted') {
                if (allData.notificationSettings && allData.notificationSettings[currentUser]?.enabled) {
                    notificationBtn.textContent = 'âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©';
                    notificationBtn.style.background = 'linear-gradient(135deg, #888 0%, #666 100%)';
                    notificationBtn.disabled = true;
                    
                    startNotificationMonitoring();
                }
            } else if (Notification.permission === 'denied') {
                notificationBtn.textContent = 'âŒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø­Ø¸ÙˆØ±Ø©';
                notificationBtn.style.background = 'linear-gradient(135deg, #e53e3e 0%, #c62828 100%)';
                notificationBtn.disabled = true;
            }
        }

        // Emergency Exit Function
        function emergencyExit() {
            localStorage.clear();
            sessionStorage.clear();
            
            window.close();
            
            setTimeout(() => {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    window.location.href = 'youtube://';
                    setTimeout(() => {
                        window.location.href = 'https://m.youtube.com';
                    }, 500);
                } else {
                    window.location.href = 'https://www.youtube.com';
                }
            }, 100);
        }

        // Handle Shift+Enter for new line
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('messageForm').dispatchEvent(new Event('submit'));
                } else if (e.key === 'Enter' && e.shiftKey) {
                    setTimeout(() => {
                        messageInput.style.height = 'auto';
                        messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
                    }, 0);
                }
            });

            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
            });
        });

        // Initialize
        initApp();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99d0d80d043de1ae',t:'MTc2Mjg5NjEzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>